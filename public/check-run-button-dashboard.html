<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🤖 AI Code Reviewer - Complete Testing Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }

        .test-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid #e1e8ed;
        }

        .section-title {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #555;
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .btn-info {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-success { background: #27ae60; }
        .status-warning { background: #f39c12; }
        .status-error { background: #e74c3c; }
        .status-info { background: #3498db; }

        .log-container {
            grid-column: 1 / -1;
            background: #1e1e1e;
            color: #f8f8f2;
            border-radius: 15px;
            padding: 25px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            line-height: 1.6;
            max-height: 500px;
            overflow-y: auto;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 8px 12px;
            border-radius: 5px;
            border-left: 4px solid transparent;
        }

        .log-success {
            background: rgba(39, 174, 96, 0.1);
            border-left-color: #27ae60;
            color: #2ecc71;
        }

        .log-error {
            background: rgba(231, 76, 60, 0.1);
            border-left-color: #e74c3c;
            color: #ff6b6b;
        }

        .log-warning {
            background: rgba(243, 156, 18, 0.1);
            border-left-color: #f39c12;
            color: #ffd93d;
        }

        .log-info {
            background: rgba(52, 152, 219, 0.1);
            border-left-color: #3498db;
            color: #74b9ff;
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            padding: 0 20px;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            position: relative;
        }

        .step::after {
            content: '';
            position: absolute;
            top: 20px;
            left: 50%;
            width: 100%;
            height: 2px;
            background: #e1e8ed;
            z-index: -1;
        }

        .step:last-child::after {
            display: none;
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e1e8ed;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            margin-bottom: 10px;
        }

        .step-active .step-circle {
            background: #667eea;
        }

        .step-completed .step-circle {
            background: #27ae60;
        }

        .step-error .step-circle {
            background: #e74c3c;
        }

        .step-label {
            font-size: 12px;
            text-align: center;
            color: #666;
            font-weight: 500;
        }

        .config-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .action-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease;
            cursor: pointer;
        }

        .action-card:hover {
            transform: translateY(-3px);
        }

        .action-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .response-viewer {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #e1e8ed;
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .tab.active {
            border-bottom-color: #667eea;
            color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .progress-bar {
            background: #e1e8ed;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            background: linear-gradient(90deg, #667eea, #764ba2);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .quick-actions {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🤖 AI Code Reviewer Testing Dashboard</h1>
            <p>Complete testing suite for GitHub App functionality - Test locally before server deployment</p>
        </div>

        <div style="padding: 30px;">
            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step step-completed" id="step-1">
                    <div class="step-circle">1</div>
                    <div class="step-label">Configuration</div>
                </div>
                <div class="step" id="step-2">
                    <div class="step-circle">2</div>
                    <div class="step-label">Webhook Test</div>
                </div>
                <div class="step" id="step-3">
                    <div class="step-circle">3</div>
                    <div class="step-label">AI Analysis</div>
                </div>
                <div class="step" id="step-4">
                    <div class="step-circle">4</div>
                    <div class="step-label">Check Run</div>
                </div>
                <div class="step" id="step-5">
                    <div class="step-circle">5</div>
                    <div class="step-label">Interactive Actions</div>
                </div>
                <div class="step" id="step-6">
                    <div class="step-circle">6</div>
                    <div class="step-label">Verification</div>
                </div>
            </div>

            <!-- Configuration Section -->
            <div class="config-section">
                <h3>🔧 Configuration & Environment</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 15px;">
                    <div>
                        <label>API Base URL:</label>
                        <input type="text" id="apiBase" value="http://localhost:3000" placeholder="http://localhost:3000">
                    </div>
                    <div>
                        <label>GitHub Repository:</label>
                        <input type="text" id="testRepo" value="codecuriousai/github_langflow_app_practice" placeholder="owner/repo">
                    </div>
                    <div>
                        <label>Test PR Number:</label>
                        <input type="number" id="testPrNumber" value="80" placeholder="80">
                    </div>
                    <div>
                        <label>Test SHA:</label>
                        <input type="text" id="testSha" value="bfac8b8b8df52eb44ce1a53832d08a47a6cfdac4" placeholder="commit sha">
                    </div>
                </div>
                <button class="btn btn-info" onclick="testConnection()">🔍 Test Connection</button>
                <button class="btn btn-success" onclick="loadEnvironment()">📋 Load Environment Info</button>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <div class="action-card" onclick="runFullTest()">
                    <div class="action-icon">🚀</div>
                    <h4>Full Test Suite</h4>
                    <p>Run complete end-to-end test</p>
                </div>
                <div class="action-card" onclick="testWebhook()">
                    <div class="action-icon">📡</div>
                    <h4>Webhook Test</h4>
                    <p>Simulate PR webhook event</p>
                </div>
                <div class="action-card" onclick="testAIAnalysis()">
                    <div class="action-icon">🧠</div>
                    <h4>AI Analysis</h4>
                    <p>Test AI code review</p>
                </div>
                <div class="action-card" onclick="testCheckRun()">
                    <div class="action-icon">✅</div>
                    <h4>Check Run</h4>
                    <p>Test interactive check run</p>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <div class="tab active" onclick="switchTab('basic-tests')">Basic Tests</div>
                <div class="tab" onclick="switchTab('advanced-tests')">Advanced Tests</div>
                <div class="tab" onclick="switchTab('interactive-tests')">Interactive Features</div>
                <div class="tab" onclick="switchTab('debug-tools')">Debug Tools</div>
            </div>

            <!-- Tab Contents -->
            <div id="basic-tests" class="tab-content active">
                <div class="main-content">
                    <div class="test-section">
                        <div class="section-title">
                            <span class="status-indicator status-info"></span>
                            🏥 Health Check Tests
                        </div>
                        <div class="form-group">
                            <button class="btn" onclick="testStatus()">📊 Check Server Status</button>
                            <button class="btn btn-info" onclick="testDebugEndpoints()">🔧 Test Debug Endpoints</button>
                        </div>
                        <div class="response-viewer" id="health-response"></div>
                    </div>

                    <div class="test-section">
                        <div class="section-title">
                            <span class="status-indicator status-warning"></span>
                            📡 Webhook Simulation
                        </div>
                        <div class="form-group">
                            <label>Event Type:</label>
                            <select id="webhookEvent">
                                <option value="pull_request">Pull Request</option>
                                <option value="check_run">Check Run</option>
                                <option value="issue_comment">Issue Comment</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Action:</label>
                            <select id="webhookAction">
                                <option value="opened">Opened</option>
                                <option value="synchronize">Synchronize</option>
                                <option value="requested_action">Requested Action</option>
                            </select>
                        </div>
                        <button class="btn btn-warning" onclick="simulateWebhook()">📡 Send Webhook</button>
                        <div class="response-viewer" id="webhook-response"></div>
                    </div>
                </div>
            </div>

            <div id="advanced-tests" class="tab-content">
                <div class="main-content">
                    <div class="test-section">
                        <div class="section-title">
                            <span class="status-indicator status-success"></span>
                            🧠 AI Service Tests
                        </div>
                        <div class="form-group">
                            <label>Test Code:</label>
                            <textarea id="testCode" rows="6" placeholder="Enter test code for AI analysis...">
function signup(username, password) {
    // SQL Injection vulnerability
    const query = "SELECT * FROM users WHERE username = '" + username + "'";
    
    // Use of eval() - security risk
    eval("var result = " + someUserInput);
    
    // Insecure random number generation
    const token = Math.random().toString(36);
    
    // Assignment in conditional
    if (user = findUser(username)) {
        return user;
    }
    
    // Deprecated arguments.callee
    return arguments.callee.name;
}
                            </textarea>
                        </div>
                        <button class="btn btn-success" onclick="testAIDirectly()">🤖 Test AI Analysis</button>
                        <button class="btn btn-info" onclick="testFixSuggestions()">🔧 Test Fix Suggestions</button>
                        <button class="btn btn-warning" onclick="testMergeReadiness()">🔍 Test Merge Readiness</button>
                        <div class="response-viewer" id="ai-response"></div>
                    </div>

                    <div class="test-section">
                        <div class="section-title">
                            <span class="status-indicator status-info"></span>
                            🔍 GitHub API Tests
                        </div>
                        <div class="form-group">
                            <button class="btn" onclick="testGitHubConnection()">🔗 Test GitHub Connection</button>
                            <button class="btn btn-info" onclick="testPRData()">📄 Fetch PR Data</button>
                            <button class="btn btn-success" onclick="testCreateCheckRun()">✅ Create Test Check Run</button>
                        </div>
                        <div class="response-viewer" id="github-response"></div>
                    </div>
                </div>
            </div>

            <div id="interactive-tests" class="tab-content">
                <div class="main-content">
                    <div class="test-section">
                        <div class="section-title">
                            <span class="status-indicator status-success"></span>
                            🎯 Interactive Features
                        </div>
                        <div class="form-group">
                            <label>Check Run ID:</label>
                            <input type="text" id="checkRunId" placeholder="Enter check run ID">
                        </div>
                        <div class="form-group">
                            <label>Action Type:</label>
                            <select id="actionType">
                                <option value="post-all">Post All Comments</option>
                                <option value="generate-fixes">Generate Fixes</option>
                                <option value="check-merge">Check Merge Ready</option>
                            </select>
                        </div>
                        <button class="btn btn-success" onclick="testInteractiveAction()">🎯 Test Interactive Action</button>
                        <button class="btn btn-info" onclick="testCommentPosting()">💬 Test Comment Posting</button>
                        <div class="response-viewer" id="interactive-response"></div>
                    </div>

                    <div class="test-section">
                        <div class="section-title">
                            <span class="status-indicator status-warning"></span>
                            🔄 End-to-End Flow
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="e2e-progress"></div>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-warning" onclick="runE2ETest()">🔄 Run Complete E2E Test</button>
                            <button class="btn btn-danger" onclick="resetTest()">🔄 Reset Test</button>
                        </div>
                        <div class="response-viewer" id="e2e-response"></div>
                    </div>
                </div>
            </div>

            <div id="debug-tools" class="tab-content">
                <div class="main-content">
                    <div class="test-section">
                        <div class="section-title">
                            <span class="status-indicator status-error"></span>
                            🐛 Debug Tools
                        </div>
                        <div class="form-group">
                            <button class="btn btn-info" onclick="viewLogs()">📋 View Server Logs</button>
                            <button class="btn btn-warning" onclick="testValidation()">✅ Test Validation</button>
                            <button class="btn btn-danger" onclick="simulateError()">❌ Simulate Error</button>
                        </div>
                        <div class="form-group">
                            <label>Custom API Endpoint:</label>
                            <input type="text" id="customEndpoint" placeholder="/api/custom-test">
                            <button class="btn" onclick="testCustomEndpoint()">🔍 Test Custom</button>
                        </div>
                        <div class="response-viewer" id="debug-response"></div>
                    </div>

                    <div class="test-section">
                        <div class="section-title">
                            <span class="status-indicator status-info"></span>
                            📊 Performance Monitor
                        </div>
                        <div id="performance-metrics">
                            <div>Response Times: <span id="avg-response-time">0ms</span></div>
                            <div>Success Rate: <span id="success-rate">0%</span></div>
                            <div>Total Requests: <span id="total-requests">0</span></div>
                        </div>
                        <button class="btn btn-info" onclick="runPerformanceTest()">🚀 Performance Test</button>
                        <div class="response-viewer" id="performance-response"></div>
                    </div>
                </div>
            </div>

            <!-- Logs Section -->
            <div class="log-container">
                <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 20px;">
                    <h3>📋 Real-time Logs</h3>
                    <div>
                        <button class="btn" onclick="clearLogs()" style="font-size: 12px; padding: 8px 16px;">🗑️ Clear</button>
                        <button class="btn btn-info" onclick="exportLogs()" style="font-size: 12px; padding: 8px 16px;">📥 Export</button>
                    </div>
                </div>
                <div id="log-output">
                    <div class="log-entry log-info">
                        <strong>[INFO]</strong> Dashboard initialized - Ready for testing
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let API_BASE = 'http://localhost:3000';
        let testResults = {};
        let logCount = 0;
        let responseTimes = [];
        let totalRequests = 0;
        let successfulRequests = 0;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadConfiguration();
            log('Dashboard loaded successfully', 'success');
        });

        // Utility functions
        function log(message, type = 'info') {
            const logOutput = document.getElementById('log-output');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            logOutput.appendChild(entry);
            logOutput.scrollTop = logOutput.scrollHeight;
            logCount++;
        }

        function clearLogs() {
            document.getElementById('log-output').innerHTML = '';
            log('Logs cleared', 'info');
        }

        function exportLogs() {
            const logs = document.getElementById('log-output').innerText;
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ai-reviewer-logs-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            log('Logs exported successfully', 'success');
        }

        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            log(`Switched to ${tabName} tab`, 'info');
        }

        function loadConfiguration() {
            API_BASE = document.getElementById('apiBase').value;
            log(`Configuration loaded - API Base: ${API_BASE}`, 'info');
        }

        function updateStep(stepNumber, status) {
            const step = document.getElementById(`step-${stepNumber}`);
            step.className = `step step-${status}`;
        }

        function updateProgress(percentage) {
            document.getElementById('e2e-progress').style.width = `${percentage}%`;
        }

        function updateMetrics() {
            const avgTime = responseTimes.length > 0 
                ? Math.round(responseTimes.reduce((a, b) => a + b, 0) / responseTimes.length)
                : 0;
            const successRate = totalRequests > 0 
                ? Math.round((successfulRequests / totalRequests) * 100)
                : 0;

            document.getElementById('avg-response-time').textContent = `${avgTime}ms`;
            document.getElementById('success-rate').textContent = `${successRate}%`;
            document.getElementById('total-requests').textContent = totalRequests;
        }

        // API call wrapper with metrics
        async function apiCall(endpoint, options = {}) {
            const startTime = Date.now();
            totalRequests++;
            
            try {
                loadConfiguration();
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                const endTime = Date.now();
                const responseTime = endTime - startTime;
                responseTimes.push(responseTime);
                
                if (response.ok) {
                    successfulRequests++;
                }
                
                updateMetrics();
                
                const data = await response.json().catch(() => ({}));
                
                log(`${options.method || 'GET'} ${endpoint} - ${response.status} (${responseTime}ms)`, 
                    response.ok ? 'success' : 'error');
                
                return { response, data, responseTime };
            } catch (error) {
                const endTime = Date.now();
                const responseTime = endTime - startTime;
                responseTimes.push(responseTime);
                updateMetrics();
                
                log(`API Error: ${error.message}`, 'error');
                throw error;
            }
        }

        // Test functions
        async function testConnection() {
            log('Testing connection to server...', 'info');
            try {
                const { response, data, responseTime } = await apiCall('/status');
                document.getElementById('health-response').textContent = JSON.stringify(data, null, 2);
                log(`Connection successful! Server is running (${responseTime}ms)`, 'success');
                updateStep(1, 'completed');
            } catch (error) {
                log(`Connection failed: ${error.message}`, 'error');
                updateStep(1, 'error');
            }
        }

        async function loadEnvironment() {
            log('Loading environment information...', 'info');
            try {
                const { data } = await apiCall('/status');
                const envInfo = {
                    server: data.server || 'Unknown',
                    timestamp: data.timestamp || new Date().toISOString(),
                    features: data.features || {}
                };
                document.getElementById('health-response').textContent = JSON.stringify(envInfo, null, 2);
                log('Environment information loaded', 'success');
            } catch (error) {
                log(`Failed to load environment: ${error.message}`, 'error');
            }
        }

        async function testDebugEndpoints() {
            log('Testing debug endpoints...', 'info');
            const endpoints = ['/status', '/debug/test-check-run-buttons', '/debug/ai-test'];
            
            for (const endpoint of endpoints) {
                try {
                    const { response, data } = await apiCall(endpoint, { method: 'POST' });
                    log(`✅ ${endpoint} - OK`, 'success');
                } catch (error) {
                    log(`❌ ${endpoint} - ${error.message}`, 'error');
                }
            }
        }

        async function simulateWebhook() {
            log('Simulating webhook event...', 'info');
            const event = document.getElementById('webhookEvent').value;
            const action = document.getElementById('webhookAction').value;
            const repo = document.getElementById('testRepo').value.split('/');
            const prNumber = document.getElementById('testPrNumber').value;
            const sha = document.getElementById('testSha').value;

            const webhookPayload = {
                action: action,
                repository: {
                    name: repo[1],
                    full_name: document.getElementById('testRepo').value,
                    owner: { login: repo[0] }
                },
                pull_request: {
                    number: parseInt(prNumber),
                    head: { sha: sha },
                    base: { ref: 'main' },
                    title: 'Test PR for AI Review',
                    user: { login: 'test-user' }
                },
                check_run: {
                    id: Math.floor(Math.random() * 1000000),
                    name: 'AI Code Review',
                    head_sha: sha
                },
                requested_action: {
                    identifier: document.getElementById('actionType').value
                }
            };

            try {
                const { response, data } = await apiCall('/webhook', {
                    method: 'POST',
                    body: JSON.stringify(webhookPayload),
                    headers: {
                        'X-GitHub-Event': event,
                        'X-GitHub-Delivery': `test-${Date.now()}`
                    }
                });

                document.getElementById('webhook-response').textContent = JSON.stringify(data, null, 2);
                log(`Webhook simulation completed for ${event}.${action}`, 'success');
                updateStep(2, 'completed');
            } catch (error) {
                log(`Webhook simulation failed: ${error.message}`, 'error');
                updateStep(2, 'error');
            }
        }

        async function testAIDirectly() {
            log('Testing AI analysis directly...', 'info');
            const testCode = document.getElementById('testCode').value;
            const repo = document.getElementById('testRepo').value.split('/');

            const aiPayload = {
                prData: {
                    title: 'Test PR for AI Analysis',
                    body: 'Testing AI code review functionality',
                    files: [{
                        filename: 'test.js',
                        patch: `+${testCode}`,
                        additions: testCode.split('\n').length,
                        changes: testCode.split('\n').length
                    }]
                },
                owner: repo[0],
                repo: repo[1],
                pullNumber: document.getElementById('testPrNumber').value
            };

            try {
                const { response, data } = await apiCall('/debug/ai-test', {
                    method: 'POST',
                    body: JSON.stringify(aiPayload)
                });

                document.getElementById('ai-response').textContent = JSON.stringify(data, null, 2);
                log('AI analysis completed successfully', 'success');
                updateStep(3, 'completed');
            } catch (error) {
                log(`AI analysis failed: ${error.message}`, 'error');
                updateStep(3, 'error');
            }
        }

        async function testFixSuggestions() {
            log('Testing fix suggestions...', 'info');
            const checkRunId = document.getElementById('checkRunId').value || '123456';

            try {
                const { response, data } = await apiCall(`/api/check-runs/${checkRunId}/generate-fixes`, {
                    method: 'POST',
                    body: JSON.stringify({
                        owner: document.getElementById('testRepo').value.split('/')[0],
                        repo: document.getElementById('testRepo').value.split('/')[1],
                        pullNumber: document.getElementById('testPrNumber').value
                    })
                });

                document.getElementById('ai-response').textContent = JSON.stringify(data, null, 2);
                log('Fix suggestions generated successfully', 'success');
            } catch (error) {
                log(`Fix suggestions failed: ${error.message}`, 'error');
            }
        }

        async function testMergeReadiness() {
            log('Testing merge readiness assessment...', 'info');
            const checkRunId = document.getElementById('checkRunId').value || '123456';

            try {
                const { response, data } = await apiCall(`/api/check-runs/${checkRunId}/check-merge`, {
                    method: 'POST',
                    body: JSON.stringify({
                        owner: document.getElementById('testRepo').value.split('/')[0],
                        repo: document.getElementById('testRepo').value.split('/')[1],
                        pullNumber: document.getElementById('testPrNumber').value
                    })
                });

                document.getElementById('ai-response').textContent = JSON.stringify(data, null, 2);
                log('Merge readiness assessment completed', 'success');
            } catch (error) {
                log(`Merge readiness assessment failed: ${error.message}`, 'error');
            }
        }

        async function testGitHubConnection() {
            log('Testing GitHub API connection...', 'info');
            try {
                const repo = document.getElementById('testRepo').value.split('/');
                const { response, data } = await apiCall(`/api/github/repo/${repo[0]}/${repo[1]}`);
                
                document.getElementById('github-response').textContent = JSON.stringify(data, null, 2);
                log('GitHub connection successful', 'success');
            } catch (error) {
                log(`GitHub connection failed: ${error.message}`, 'error');
            }
        }

        async function testPRData() {
            log('Fetching PR data...', 'info');
            try {
                const repo = document.getElementById('testRepo').value.split('/');
                const prNumber = document.getElementById('testPrNumber').value;
                
                const { response, data } = await apiCall(`/api/github/pr/${repo[0]}/${repo[1]}/${prNumber}`);
                
                document.getElementById('github-response').textContent = JSON.stringify(data, null, 2);
                log('PR data fetched successfully', 'success');
            } catch (error) {
                log(`Failed to fetch PR data: ${error.message}`, 'error');
            }
        }

        async function testCreateCheckRun() {
            log('Creating test check run...', 'info');
            try {
                const repo = document.getElementById('testRepo').value.split('/');
                const sha = document.getElementById('testSha').value;

                const checkRunData = {
                    name: 'AI Code Review',
                    head_sha: sha,
                    status: 'completed',
                    conclusion: 'neutral',
                    output: {
                        title: 'Test Check Run',
                        summary: 'This is a test check run created from the dashboard',
                        text: 'Test check run details...'
                    },
                    actions: [
                        { label: 'Post All Comments', description: 'Post all findings', identifier: 'post-all' },
                        { label: 'Generate Fixes', description: 'Get AI fix suggestions', identifier: 'generate-fixes' },
                        { label: 'Check Merge Ready', description: 'Assess merge readiness', identifier: 'check-merge' }
                    ]
                };

                const { response, data } = await apiCall('/debug/test-check-run-buttons', {
                    method: 'POST',
                    body: JSON.stringify({
                        owner: repo[0],
                        repo: repo[1],
                        headSha: sha,
                        checkRunData: checkRunData
                    })
                });

                document.getElementById('github-response').textContent = JSON.stringify(data, null, 2);
                if (data.checkRun && data.checkRun.id) {
                    document.getElementById('checkRunId').value = data.checkRun.id;
                }
                log('Check run created successfully', 'success');
                updateStep(4, 'completed');
            } catch (error) {
                log(`Check run creation failed: ${error.message}`, 'error');
                updateStep(4, 'error');
            }
        }

        async function testInteractiveAction() {
            log('Testing interactive action...', 'info');
            const checkRunId = document.getElementById('checkRunId').value;
            const actionType = document.getElementById('actionType').value;

            if (!checkRunId) {
                log('Please enter a check run ID or create a check run first', 'warning');
                return;
            }

            try {
                let endpoint;
                switch (actionType) {
                    case 'post-all':
                        endpoint = `/api/check-runs/${checkRunId}/post-comments`;
                        break;
                    case 'generate-fixes':
                        endpoint = `/api/check-runs/${checkRunId}/generate-fixes`;
                        break;
                    case 'check-merge':
                        endpoint = `/api/check-runs/${checkRunId}/check-merge`;
                        break;
                }

                const { response, data } = await apiCall(endpoint, {
                    method: 'POST',
                    body: JSON.stringify({
                        owner: document.getElementById('testRepo').value.split('/')[0],
                        repo: document.getElementById('testRepo').value.split('/')[1],
                        pullNumber: document.getElementById('testPrNumber').value
                    })
                });

                document.getElementById('interactive-response').textContent = JSON.stringify(data, null, 2);
                log(`Interactive action ${actionType} completed successfully`, 'success');
                updateStep(5, 'completed');
                
                // MODIFICATION: Auto-refresh after successful post-all action
                if (actionType === 'post-all') {
                    log('Post all comments completed! Refreshing page in 2 seconds...', 'success');
                    setTimeout(() => {
                        log('🔄 Refreshing page to see updated state...', 'info');
                        window.location.reload();
                    }, 2000);
                }
            } catch (error) {
                log(`Interactive action failed: ${error.message}`, 'error');
                updateStep(5, 'error');
            }
        }

        async function runE2ETest() {
            log('Starting end-to-end test...', 'info');
            updateProgress(0);

            const steps = [
                { name: 'Connection Test', func: testConnection, progress: 16 },
                { name: 'Webhook Simulation', func: simulateWebhook, progress: 33 },
                { name: 'AI Analysis', func: testAIDirectly, progress: 50 },
                { name: 'Check Run Creation', func: testCreateCheckRun, progress: 66 },
                { name: 'Interactive Action', func: testInteractiveAction, progress: 83 },
                { name: 'Final Verification', func: testStatus, progress: 100 }
            ];

            for (let i = 0; i < steps.length; i++) {
                const step = steps[i];
                log(`Running ${step.name}...`, 'info');
                
                try {
                    await step.func();
                    updateProgress(step.progress);
                    await new Promise(resolve => setTimeout(resolve, 1000)); // Wait 1 second between steps
                } catch (error) {
                    log(`E2E Test failed at ${step.name}: ${error.message}`, 'error');
                    return;
                }
            }

            log('End-to-end test completed successfully!', 'success');
            updateStep(6, 'completed');
            
            // MODIFICATION: Auto-refresh page after successful code review
            log('Code review completed successfully! Refreshing page in 3 seconds...', 'success');
            setTimeout(() => {
                log('🔄 Refreshing page...', 'info');
                window.location.reload();
            }, 3000);
        }

        async function runPerformanceTest() {
            log('Running performance test...', 'info');
            const iterations = 10;
            const startTime = Date.now();

            for (let i = 0; i < iterations; i++) {
                try {
                    await apiCall('/status');
                    log(`Performance test ${i + 1}/${iterations} completed`, 'info');
                } catch (error) {
                    log(`Performance test ${i + 1} failed: ${error.message}`, 'error');
                }
            }

            const totalTime = Date.now() - startTime;
            const avgTime = totalTime / iterations;

            document.getElementById('performance-response').textContent = 
                `Performance Test Results:\n` +
                `Total Time: ${totalTime}ms\n` +
                `Average Time: ${avgTime.toFixed(2)}ms\n` +
                `Requests/Second: ${(1000 / avgTime).toFixed(2)}\n` +
                `Success Rate: ${Math.round((successfulRequests / totalRequests) * 100)}%`;

            log(`Performance test completed - Avg: ${avgTime.toFixed(2)}ms`, 'success');
        }

        async function testCustomEndpoint() {
            const endpoint = document.getElementById('customEndpoint').value;
            if (!endpoint) {
                log('Please enter a custom endpoint', 'warning');
                return;
            }

            log(`Testing custom endpoint: ${endpoint}`, 'info');
            try {
                const { response, data } = await apiCall(endpoint);
                document.getElementById('debug-response').textContent = JSON.stringify(data, null, 2);
                log(`Custom endpoint test successful`, 'success');
            } catch (error) {
                log(`Custom endpoint test failed: ${error.message}`, 'error');
            }
        }

        function resetTest() {
            // Reset all steps
            for (let i = 1; i <= 6; i++) {
                updateStep(i, i === 1 ? 'completed' : '');
            }
            
            // Clear all response viewers
            document.querySelectorAll('.response-viewer').forEach(viewer => {
                viewer.textContent = '';
            });
            
            // Reset progress
            updateProgress(0);
            
            // Reset metrics
            responseTimes = [];
            totalRequests = 0;
            successfulRequests = 0;
            updateMetrics();
            
            log('Test environment reset', 'info');
        }

        // Additional utility functions
        function testStatus() {
            return testConnection();
        }

        function testWebhook() {
            return simulateWebhook();
        }

        function testAIAnalysis() {
            return testAIDirectly();
        }

        function testCheckRun() {
            return testCreateCheckRun();
        }

        function runFullTest() {
            return runE2ETest();
        }

        function testCommentPosting() {
            document.getElementById('actionType').value = 'post-all';
            return testInteractiveAction();
        }

        function testValidation() {
            log('Testing validation with invalid data...', 'info');
            // Test with invalid data to check validation
            const originalRepo = document.getElementById('testRepo').value;
            document.getElementById('testRepo').value = 'invalid/repo/name/too/long';
            
            testConnection().finally(() => {
                document.getElementById('testRepo').value = originalRepo;
                log('Validation test completed', 'info');
            });
        }

        function simulateError() {
            log('Simulating error condition...', 'warning');
            apiCall('/non-existent-endpoint').catch(() => {
                log('Error simulation completed', 'info');
            });
        }

        function viewLogs() {
            log('Viewing server logs (this would connect to server logs in production)', 'info');
            document.getElementById('debug-response').textContent = 
                'Server logs would be displayed here.\n' +
                'In production, this would fetch actual server logs.\n' +
                'Current dashboard logs: ' + logCount + ' entries';
        }
    </script>
</body>
</html>